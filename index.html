<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laskin ja Kello (Lopullinen Korjaus)</title>
    <style>
        :root {
            --primary-bg: #2a2a2a;
            --secondary-bg: #1e1e1e;
            --border-color: #444;
            --key-bg: #404040;
            --key-active-bg: #6a6a6a;
            --operator-bg: #005f87;
            --large-num-bg: #4b0082;
            --text-color: white;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--primary-bg);
            font-family: 'Segoe UI', 'Noto Sans', sans-serif;
            color: var(--text-color);
            margin: 0;
            flex-direction: column;
        }

        .toggle-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            background-color: var(--key-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 15px;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .toggle-btn:hover {
            background-color: var(--key-active-bg);
        }
        
        .main-container {
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            background-color: var(--secondary-bg);
            width: 90vw;
            max-width: 480px;
            min-width: 300px;
            overflow: hidden;
            min-height: 550px; 
            display: flex;
            flex-direction: column;
        }

        /* Laskin */
        .calculator {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .display {
            background-color: #1a1a1a;
            font-size: 2.5em;
            text-align: right;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            min-height: 70px;
            line-height: 1.5;
        }
        .display::-webkit-scrollbar { height: 5px; }
        .display::-webkit-scrollbar-track { background: #1a1a1a; }
        .display::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }

        .keys {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #333;
            flex-grow: 1;
        }

        .key {
            background-color: var(--key-bg);
            border: none;
            color: var(--text-color);
            padding: 18px;
            font-size: 1.6em;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            position: relative;
        }
        
        .key:hover::after { content: attr(title); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #555; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.6em; white-space: nowrap; margin-bottom: 5px; z-index: 10; }
        .key:disabled { background-color: #3a3a3a; cursor: default; }
        .key:active:not(:disabled) { background-color: var(--key-active-bg); }
        .key.operator { background-color: var(--operator-bg); }
        .key.function { background-color: #6d6d6d; }
        .key.large-number { background-color: var(--large-num-bg); }
        #key-equals { background-color: #007acc; }

        /* Kello */
        .clock-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
        }

        .clock-face {
            position: relative;
            width: 90%;
            padding-bottom: 90%;
            border: 4px solid var(--text-color);
            border-radius: 50%;
            background: var(--secondary-bg);
            margin-bottom: 20px;
        }
        
        #year-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: #ccc;
            z-index: 1;
        }

        .clock-face .hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom;
            border-radius: 2px;
            z-index: 2;
        }
        
        .month-hand { height: 20%; width: 8px; background: #2e8b57; }
        .hour-hand { height: 25%; width: 6px; background: #007acc; }
        .minute-hand { height: 35%; width: 4px; background: #0099ff; }
        .second-hand { height: 40%; width: 2px; background: red; }
        
        .clock-face .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            border: 2px solid var(--text-color);
            z-index: 3;
        }

        .clock-face .number {
            position: absolute;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color);
        }

        #timezone-select {
            padding: 8px;
            background-color: var(--key-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
        }
    </style>
</head>
<body>

    <div class="toggle-controls">
        <button class="toggle-btn" id="toggle-calc" title="Laskin">üñ©</button>
        <button class="toggle-btn" id="toggle-clock" title="Kello">üï∞Ô∏è</button>
    </div>

    <div class="main-container">
        <div class="calculator" id="calculator">
            <div class="display" id="display">œô</div>
            <div class="keys">
                <button class="key function" id="key-clear" title="Esc" style="grid-column: span 4;">C</button>
                <button class="key large-number" data-value="‡®®" data-key="z" title="z (12¬≥)">‡®®</button>
                <button class="key large-number" data-value="—™" data-key="x" title="x (12‚Åπ)">—™</button>
                <button class="key large-number" data-value="Ïò§" data-key="c" title="c (12¬≤‚Å∑)">Ïò§</button>
                <button class="key operator" data-op="*" data-key="*" title="*">√ó</button>
                <button class="key" data-value="êÖ°" data-key="a" title="a (10)">êÖ°</button>
                <button class="key" data-value="êÜÖ" data-key="s" title="s (11)">êÜÖ</button>
                <button class="key" disabled></button>
                <button class="key operator" data-op="/" data-key="/" title="/">√∑</button>
                <button class="key" data-value="‡Æ™" data-key="i" title="i (7)">‡Æ™</button>
                <button class="key" data-value="ëÄ¨" data-key="o" title="o (8)">ëÄ¨</button>
                <button class="key" data-value="œ∑" data-key="p" title="p (9)">œ∑</button>
                <button class="key operator" data-op="-" data-key="-" title="-">‚àí</button>
                <button class="key" data-value="ê§Ñ" data-key="t" title="t (4)">ê§Ñ</button>
                <button class="key" data-value="¬¨" data-key="y" title="y (5)">¬¨‚Äé</button>
                <button class="key" data-value="ëÄ´" data-key="u" title="u (6)">ëÄ´</button>
                <button class="key operator" data-op="+" data-key="+" title="+">+</button>
                <button class="key" data-value="√Æ" data-key="w" title="w (1)">√Æ</button>
                <button class="key" data-value="…Ö" data-key="e" title="e (2)">…Ö</button>
                <button class="key" data-value="·àê" data-key="r" title="r (3)">·àê</button>
                <button class="key operator" id="key-equals" data-op="=" data-key="Enter" title="Enter">=</button>
                <button class="key large-number" data-value="œô" data-key="q" title="q (0)" style="grid-column: span 4;">œô</button>
            </div>
        </div>
        
        <div class="clock-container" id="clock-container">
            <div class="clock-face" id="clock-face">
                <div id="year-display"></div>
                <div class="hand month-hand" id="month-hand"></div>
                <div class="hand hour-hand" id="hour-hand"></div>
                <div class="hand minute-hand" id="minute-hand"></div>
                <div class="hand second-hand" id="second-hand"></div>
                <div class="center-dot"></div>
            </div>
            <label for="timezone-select">Aikavy√∂hyke:</label>
            <select id="timezone-select"></select>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- YLEISET ELEMENTIT JA VAKIOT ---
            const calculator = document.getElementById('calculator');
            const clockContainer = document.getElementById('clock-container');
            const toggleCalcBtn = document.getElementById('toggle-calc');
            const toggleClockBtn = document.getElementById('toggle-clock');

            const SYMBOLS = { 'œô': 0n, '√Æ': 1n, '…Ö': 2n, '·àê': 3n, 'ê§Ñ': 4n, '¬¨': 5n, 'ëÄ´': 6n, '‡Æ™': 7n, 'ëÄ¨': 8n, 'œ∑': 9n, 'êÖ°': 10n, 'êÜÖ': 11n };
            const VALUE_TO_SYMBOL = Object.fromEntries(Object.entries(SYMBOLS).map(([s, v]) => [v, s]));

            // --- LASKIMEN FUNKTIOT ---
            const toDoz = (decimalBigInt) => {
                if (decimalBigInt === 0n) return 'œô';
                if (decimalBigInt < 0n) return '-' + toDoz(-decimalBigInt);
                let result = '';
                let num = decimalBigInt;
                while (num > 0n) {
                    result = VALUE_TO_SYMBOL[num % 12n] + result;
                    num = num / 12n;
                }
                return result;
            };

            // --- N√ÑKYM√ÑN VAIHTO ---
            toggleCalcBtn.addEventListener('click', () => { clockContainer.style.display = 'none'; calculator.style.display = 'flex'; });
            toggleClockBtn.addEventListener('click', () => { calculator.style.display = 'none'; clockContainer.style.display = 'flex'; });

            // --- KELLON LOGIIKKA ---
            const hourHand = document.getElementById('hour-hand');
            const minuteHand = document.getElementById('minute-hand');
            const secondHand = document.getElementById('second-hand');
            const monthHand = document.getElementById('month-hand');
            const yearDisplay = document.getElementById('year-display');
            const clockFace = document.getElementById('clock-face');
            const timezoneSelect = document.getElementById('timezone-select');

            function populateTimezoneSelect() {
                const timezones = Intl.supportedValuesOf('timeZone');
                const currentUserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                timezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = tz.replace(/_/g, ' ');
                    if (tz === currentUserTimezone) { option.selected = true; }
                    timezoneSelect.appendChild(option);
                });
            }
            
            function drawClockNumbers() {
                const dozenalNumerals = ['√Æ', '…Ö', '·àê', 'ê§Ñ', '¬¨', 'ëÄ´', '‡Æ™', 'ëÄ¨', 'œ∑', 'êÖ°', 'êÜÖ', '√Æœô'];
                const radius = 42;
                dozenalNumerals.forEach((numeral, i) => {
                    const angle = (((i + 1) / 12) * 360 * Math.PI / 180) - (Math.PI / 2);
                    const x = 50 + radius * Math.cos(angle);
                    const y = 50 + radius * Math.sin(angle);
                    const numElement = document.createElement('div');
                    numElement.className = 'number';
                    numElement.textContent = numeral;
                    numElement.style.left = `${x}%`;
                    numElement.style.top = `${y}%`;
                    clockFace.appendChild(numElement);
                });
            }

            function setClock() {
                const selectedTz = timezoneSelect.value;
                const now = new Date();

                // --- UUDET, KORJATUT LASKENTATAVAT ---
                const options = (part) => ({ timeZone: selectedTz, [part]: 'numeric' });
                const hourOptions = { timeZone: selectedTz, hour: 'numeric', hourCycle: 'h23' };

                const year = BigInt(new Intl.DateTimeFormat('en-US', options('year')).format(now));
                const month = parseInt(new Intl.DateTimeFormat('en-US', options('month')).format(now), 10);
                const hours = parseInt(new Intl.DateTimeFormat('en-US', hourOptions).format(now), 10);
                const minutes = parseInt(new Intl.DateTimeFormat('en-US', options('minute')).format(now), 10);
                const seconds = parseInt(new Intl.DateTimeFormat('en-US', options('second')).format(now), 10);

                // Viisarin asento lasketaan suoraan (arvo / maksimiarvo) * 360 astetta.
                // Ei en√§√§ virheellisi√§ +90 asteen siirtymi√§.
                const secondsDegrees = (seconds / 60) * 360;
                const minutesDegrees = (minutes / 60) * 360 + (seconds / 60) * 6; // +osuus sekunneista
                const hoursDegrees = ((hours % 12) / 12) * 360 + (minutes / 60) * 30; // +osuus minuuteista
                
                // Kuukausi (1-12) asetetaan suoraan kellotaululle.
                // Hein√§kuu (7) osoittaa nyt 7. symbolia.
                const monthDegrees = (month / 12) * 360;
                // --- KORJAUSTEN LOPPU ---

                secondHand.style.transform = `rotate(${secondsDegrees}deg)`;
                minuteHand.style.transform = `rotate(${minutesDegrees}deg)`;
                hourHand.style.transform = `rotate(${hoursDegrees}deg)`;
                monthHand.style.transform = `rotate(${monthDegrees}deg)`;
                
                yearDisplay.textContent = toDoz(year);
            }
            
            timezoneSelect.addEventListener('change', setClock);
            
            populateTimezoneSelect();
            drawClockNumbers();
            setClock();
            setInterval(setClock, 1000);

            // --- LASKIMEN LOGIIKKA (ennallaan) ---
            const display = document.getElementById('display');
            const keys = document.querySelector('.keys');
            const LARGE_NUMBERS = { '‡®®': 12n ** 3n, '—™': 12n ** 9n, 'Ïò§': 12n ** 27n };
            const KEY_MAP = { 'q': 'œô', 'w': '√Æ', 'e': '…Ö', 'r': '·àê', 't': 'ê§Ñ', 'y': '¬¨', 'u': 'ëÄ´', 'i': '‡Æ™', 'o': 'ëÄ¨', 'p': 'œ∑', 'a': 'êÖ°', 's': 'êÜÖ', 'z': '‡®®', 'x': '—™', 'c': 'Ïò§', '+': '+', '-': '-', '*': '*', '/': '/', '=': '=', 'Enter': '=', 'Escape': 'C', 'Delete': 'C', 'Backspace': 'Backspace' };
            let displayValue = 'œô', firstOperand = null, operator = null, waitingForSecondOperand = false;
            const updateDisplay = () => display.textContent = displayValue;
            const toDecimal = (s) => [...s].reduce((a,c) => (SYMBOLS[c]!==undefined) ? (a*12n)+SYMBOLS[c] : a, 0n);
            const inputDigit = (d) => { if(waitingForSecondOperand){displayValue=d;waitingForSecondOperand=false;}else{displayValue=(displayValue==='œô')?d:displayValue+d;} };
            const inputLargeNumber = (s) => { displayValue=toDoz(LARGE_NUMBERS[s]); waitingForSecondOperand=false; };
            const resetCalculator = () => { displayValue='œô';firstOperand=null;operator=null;waitingForSecondOperand=false;updateDisplay(); };
            const performCalculation = () => {
                if (operator===null || firstOperand===null) return;
                const secondOperand = toDecimal(displayValue);
                if (operator==='/' && secondOperand===0n) { alert("Nollalla jako ei ole sallittu."); return 'error'; }
                let r=0n;
                switch (operator){ case '+':r=firstOperand+secondOperand;break; case '-':r=firstOperand-secondOperand;break; case '*':r=firstOperand*secondOperand;break; case '/':r=firstOperand/secondOperand;break; }
                return r;
            };
            const handleOperator = (nextOp) => {
                const inputVal = toDecimal(displayValue);
                if(operator&&waitingForSecondOperand){operator=nextOp;return;}
                if(firstOperand===null){firstOperand=inputVal;}else if(operator){const r=performCalculation();if(r==='error'){resetCalculator();return;}displayValue=toDoz(r);firstOperand=r;}
                waitingForSecondOperand=true;operator=nextOp;updateDisplay();
            };
            keys.addEventListener('click', (e) => {
                const {target}=e; if(!target.matches('button:not(:disabled)'))return;
                if(target.dataset.value){if(LARGE_NUMBERS[target.dataset.value]){inputLargeNumber(target.dataset.value);}else{inputDigit(target.dataset.value);}}
                else if(target.dataset.op){if(target.dataset.op==='='){const r=performCalculation();if(r==='error'){resetCalculator();return;}if(r!==undefined){displayValue=toDoz(r);operator=null;firstOperand=null;waitingForSecondOperand=false;}}else{handleOperator(target.dataset.op);}}
                else if(target.id==='key-clear'){resetCalculator();}
                updateDisplay();
            });
            document.addEventListener('keydown', (e) => {
                if(calculator.style.display==='none')return; if(e.key===' '||e.key==='Enter')e.preventDefault();
                const action=KEY_MAP[e.key]; if(!action)return;
                if(action==='Backspace'){displayValue=displayValue.length>1?displayValue.slice(0,-1):'œô';updateDisplay();return;}
                const btn=document.querySelector(`[data-key="${e.key}"]`)||document.querySelector(`[data-value="${action}"]`)||document.getElementById('key-clear');
                if(btn&&!btn.disabled){btn.click();btn.style.transform='scale(0.95)';setTimeout(()=>btn.style.transform='',100);}
            });
        });
    </script>
</body>
</html>
